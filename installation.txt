 ░▒▓██████▓▒░░▒▓████████▓▒░▒▓█▓▒░      ░▒▓██████▓▒░░▒▓███████▓▒░ ░▒▓██████▓▒░  
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░      ░▒▓██████▓▒░ ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓████████▓▒░ 
░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ 
 ░▒▓██████▓▒░░▒▓████████▓▒░▒▓████████▓▒░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ 

## Install a fresh CachyOS without Desktop Environment, then follow the steps. ##
## I suggest choosing "grub" or "limine" bootloader and "Btrfs" as filesystem.
## Reason: so you can profit from snapper integration to load snapshots of the
## system if something breaks.
## I prefer fish shell over zsh, so if you wish you can deselect the CachyOS zsh config.
## Unselect the Firefox configuration because we use zen-browser with Celona.

## install cachyos WITHOUT Desktop environment # we want a minimal system
## log into your system

# important, only if you chosse Btrfs filesystem perform next lines! Else, skip and continue at line 42
sudo snapper -c home create-config /home

# check if the snapper configuration files for root and home are created:
sudo snapper list-configs   # it should show up home and root lines.
sudo snapper -c root set-config ALLOW_USERS="$USER" SYNC_ACL=yes
sudo snapper -c home set-config ALLOW_USERS="$USER" SYNC_ACL=yes
sudo micro /etc/updatedb.conf  #add .snapshots to prunenames -> PRUNENAMES = ".git .hg .svn .snapshots" then save and quit Ctrl+s Ctrl+q

#note: on cachyOS the next 4 lines are already configured, skip it and continue at line 35
#if you selected grub bootloader check: sudo micro /etc/mkinitcpio.conf    #at HOOKS= add -> grub-btrfs-overlayfs then save and quit Ctrl+s Ctrl+q
#if you selected grub bootloader type: sudo mkinitcpio -P
#if you selected grub bootloader type: sudo systemctl enable --now grub-btrfsd.service
#if you selected grub bootloader check if btrfsd service is running: sudo systemctl status grub-btrfsd.service

# now we disable automatic timeline snapshots for the installation, we will turn it on again after finished installation!
sudo systemctl disable --now snapper-timeline.timer snapper-cleanup.timer

# create pre snapshot before Celona installation, the state where you can go back if you dont like Celona
snapper -c root create -t pre -c number -d 'pre Celona installation'
snapper -c home create -t pre -c number -d 'pre Celona installation'

# you can check the snapshots with "snapper ls" for root snapshots and "snapper -c home ls" for home snapshots #

### Install the Celona Bar ### ### continue here ############
mkdir ~/.config/quickshell
cd ~/.config/quickshell
git clone https://github.com/myinqi/Celona.git
cd 
sudo pacman -S niri   (chosse option 3: xdg-desktop-portal-gnome)
sudo pacman -S ghostty cliphist
# start niri once to create config file
niri-session  # exit it with SHIFT+SUPER+E

micro ~/.config/niri/config.kdl
# Line 16 uncomment and set your keyboard layout (de, us, ru .... what ever you want)
# Line 365 change to: alacritty to ghostty in the spawn -> { spawn "ghostty"; }
# change complete line 272 (the waybar spawn) to:   spawn-at-startup "bash" "-c" "wl-paste --watch cliphist store &"  #save and quit Ctrl+s Ctrl+q


run niri-session
# open two terminals (SUPER+T)
# in one of the terminals: micro ~/.config/quickshell/Celona/installation.txt
# in the secound terminal past the next commands ...

### Preperations ###
sudo pacman -S --needed base-devel micro fuzzel git zen-browser quickshell nautilus sddm gvfs udisks2 polkit polkit-gnome cliphist cava xwayland-satellite playerctl hyprlock haruna htop nvtop xdg-desktop-portal-gnome gnome-keyring swww nm-connection-editor network-manager-applet swaync ttf-jetbrains-mono-nerd gnome-text-editor kvantum kvantum-qt5 qt6ct qt5ct hyprpicker ttf-jetbrains-mono-nerd ttf-jetbrains-mono woff2-font-awesome otf-font-awesome rust gimp xdg-desktop-portal-kde dolphin kio kio-extras kde-cli-tools desktop-file-utils shared-mime-info archlinux-xdg-menu xdg-utils kcalc
sudo systemctl enable --now udisks2

### Polkit Agent with systemd ###
/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 & disown

mkdir -p ~/.config/systemd/user
sudo rsync -a ~/.config/quickshell/Celona/.systemd/polkit-agent.service ~/.config/systemd/user/polkit-agent.service

## activate ##
systemctl --user daemon-reload
systemctl --user enable --now polkit-agent.service
systemctl --user add-wants niri.service polkit-agent.service
sudo systemctl enable sddm.service


## Portals config ##
sudo rsync -a ~/.config/quickshell/Celona/.portal/niri-portals.conf /usr/share/xdg-desktop-portal/niri-portals.conf


## activate ##
systemctl --user restart xdg-desktop-portal.service \
  xdg-desktop-portal-gtk.service xdg-desktop-portal-gnome.service plasma-xdg-desktop-portal-kde.service

sudo update-desktop-database
XDG_MENU_PREFIX=arch- kbuildsycoca6 --noincremental

# next step may take some time to complete on cachyos its already installed, skip it and continue at line 100
#git clone https://aur.archlinux.org/paru.git
#cd paru
#makepkg -si

#cd ..

#sudo rm -r paru
sudo rsync -a ~/.config/quickshell/Celona/.paru/paru.conf /etc/paru.conf


# next we install some packages from the AUR
paru -S --noconfirm --needed --skipreview --removemake --cleanafter sddm-silent-theme bibata-cursor-theme-bin nwg-look kora-icon-theme mpvpaper matugen

paru -Syu

### Install Hyprgreetr
git clone https://github.com/myinqi/hyprgreetr.git
cd hyprgreetr
cargo build --release
cargo install --path .


# add PATH 
fish_add_path ~/.cargo/bin

hyprgreetr
rsync -a ~/hyprgreetr/assets/ ~/.config/hyprgreetr/pngs/
cd ..
sudo rm -r hyprgreetr
sudo rsync -a ~/.config/quickshell/Celona/.fish/config.fish ~/.config/fish/config.fish
sudo rsync -a ~/.config/quickshell/Celona/.fish/cachyos-config.fish /usr/share/cachyos-fish-config/cachyos-config.fish


### Theme settings in terminal ###
gsettings set org.gnome.desktop.interface icon-theme 'kora-pgrey'
gsettings set org.gnome.desktop.interface cursor-theme 'Bibata-Modern-Ice'
gsettings set org.gnome.desktop.interface cursor-size 28
kwriteconfig6 --file kdeglobals --group Icons --key Theme "kora-pgrey"
kbuildsycoca6 --noincremental


### Set the Celona configuration ###
#Copy the .config Folder from the Celona Repo into your local .config Folder und override existing files there.
sudo rsync -a ~/.config/quickshell/Celona/.sddm_conf/sddm.conf /etc/sddm.conf
rsync -a ~/.config/quickshell/Celona/.config/ ~/.config/
sudo rsync -a ~/.config/quickshell/Celona/.sddm_conf/metadata.desktop /usr/share/sddm/themes/silent/metadata.desktop
sudo rsync -a ~/.config/quickshell/Celona/.sddm_conf/celona.conf /usr/share/sddm/themes/silent/configs/
sudo rsync -a ~/.config/quickshell/Celona/wallpapers/3440x1440/ /usr/share/sddm/themes/silent/backgrounds/
sudo rsync -a ~/.config/quickshell/Celona/.environment/environment /etc/environment
bash ~/.config/fuzzel/install-pickers.sh

#reboot your system
reboot

#log into the system, klick the gear icon on the lift side of the bar. Make your changes. Don't forget to set your Wallpaper. Switch theme from dark to light and back to trigger matugen.
#for the frist days its a good choice to enable the Keybindis Module, so you can access the important Keybindings from the Bar.

#final setep (your keyboard and display settings):
micro ~/.config/niri/config.kdl

# on line 16 set your prefered keyboard layout again "us" "de" ...
# on line 82 set your resolution and refresh rate. In my case mode "3440x1440@165.030" but yours is maybe "1920x1080@60.030"
# on line 128 set your max horizontal resulutions minus some pixels. I chosse -20 pixel
# save and exit Ctrl+S Ctrl+Q
# if you cant to customize edit the hyprgreetr config -> micro ~/.config/hyprgreetr/config.toml

# Optional if you created a pre snapshot before installation: create post snapshot after Celona installation
snapper ls
snapper -c root create -t post --pre-number <the number of your pre celona snapshot> -c number -d 'post Celona installation'
clear
snapper -c home ls
snapper -c home create -t post --pre-number <the number of your pre celona snapshot> -c number -d 'post Celona installation'


##CachyOS Tuning, open Terminal SUPER+Return
mirror

#optional if you plan to play some games:
sudo pacman -S cachyos-gaming-meta

#read the CachyOS Wiki -> https://wiki.cachyos.org/

#END - ejoy your CachyOS Celona Environment :-)
#enable timeline shapshots again:
sudo snapper -c home set-config TIMELINE_CREATE=no   #this disables timeline snapshots for home directory only root snaphots, if you don't want this, skipt this line
sudo systemctl enable --now snapper-timeline.timer
sudo systemctl enable --now snapper-cleanup.timer




#Uninstall Celona:
#Want to undo all installations and get rid of Celona?
#Sure???? ok:
snapper ls
sudo snapper -c root undochange <number of your pre snapshot>..<number of your post snapshot>
clear
snapper -c home ls
sudo snapper -c home undochange <number of your pre snapshot>..<number of your post snapshot>
reboot


