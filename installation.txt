## Install a fresh CachyOS without Desktop Environment, then follow the steps. ##
## I suggest choosing "grub" or "limine" bootloader and "Btrfs" as filesystem.
## Reason: so you can profit from snapper integration to load snapshots of the
## system if something breaks.
## I prefer fish shell over zsh, so if you wish you can deselect the CachyOS zsh config.
## Unselect the Firefox configuration

++ install cachyos without Desktop environment
++ log into your system

### Install the Celona Bar ###
mkdir ~/.config/quickshell
cd ~/.config/quickshell
git clone https://github.com/myinqi/Celona.git
cd 
++ sudo pacman -S niri   (chosse option 3: xdg-desktop-portal-gnome)
++ sudo pacman -S ghostty cliphist
++ micro ~/.config/niri/config.kdl
++ Line 16 uncomment and set your keyboard layout (de, us, ru .... what ever you want)
++ Line 365 change to: alacritty to ghostty in the spawn -> { spawn "ghostty"; }
++ change complete line 271 to:   spawn-at-startup "bash" "-c" "wl-paste --watch cliphist store &"

++ Ctrl+S
++ Ctrl+Q

++ run niri-session
++ open two terminals (SUPER+T)
++ in one of the terminals: micro ~/.config/quickshell/Celona/installation.txt
++ in the secound terminal past the next commands ...

### Preperations ###
sudo pacman -S --needed base-devel micro fuzzel git zen-browser quickshell nautilus sddm gvfs udisks2 polkit polkit-gnome cliphist cava xwayland-satellite playerctl hyprlock haruna htop nvtop xdg-desktop-portal-gnome gnome-keyring swww nm-connection-editor network-manager-applet swaync ttf-jetbrains-mono-nerd gnome-text-editor

sudo systemctl enable --now udisks2


### Polkit Agent with systemd ###
/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 & disown

mkdir -p ~/.config/systemd/user

micro ~/.config/systemd/user/polkit-agent.service
	## past content ##

[Unit]
Description=Polkit authentication agent
PartOf=niri.service
After=graphical-session.target

[Service]
ExecStart=/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
Restart=on-failure

[Install]
WantedBy=niri.service

##end

Ctrl+S
Ctrl+Q


## activate ##
systemctl --user daemon-reload
systemctl --user enable --now polkit-agent.service
systemctl --user add-wants niri.service polkit-agent.service
sudo systemctl enable sddm.service


## Portals config ##
micro /usr/share/xdg-desktop-portal/niri-portals.conf
	## change content to ##
[preferred]
default=gnome;gtk;
org.freedesktop.impl.portal.Access=gnome-shell;gtk;
org.freedesktop.impl.portal.Secret=gnome-keyring;
org.freedesktop.impl.portal.ScreenCast=gnome;
org.freedesktop.impl.portal.FileChooser=gnome;
org.freedesktop.impl.portal.Notification=gnome;gtk;	

##end

## activate ##
systemctl --user restart xdg-desktop-portal.service \
  xdg-desktop-portal-gtk.service xdg-desktop-portal-gnome.service


# next step may take some time to complete
git clone https://aur.archlinux.org/paru.git
cd paru
makepkg -si

cd ..
#remove Folder, not longer needed
sudo rm -r paru

micro /etc/paru.conf
uncomment line 17 ->   BottomUP
Ctrl+S
Ctrl+Q

micro ~/.config/micro/settings.json
replace "catppuccin-macchiato" with "simple"
Ctrl+S
Ctrl+Q

# next we install some packages from the AUR
paru -S --noconfirm --needed --skipreview --removemake --cleanafter sddm-silent-theme bibata-cursor-theme-bin nwg-look kora-icon-theme mpvpaper matugen


### Install Hyprgreetr
git clone https://github.com/myinqi/hyprgreetr.git
cd hyprgreetr
cargo build --release
cargo install --path .



# add PATH 
fish_add_path ~/.cargo/bin

hyprgreetr
rsync -a ~/hyprgreetr/assets/ ~/.config/hyprgreetr/pngs/
cd ..
sudo rm -r hyprgreetr

# preload config for hyprgreetr, simply type "hyprgreetr" and then RETURN
hyprgreetr
# if you cant to customize edit the hyprgreetr config -> micro ~/.config/hyprgreetr/config.toml
# warning if you later choose in Celona to set colors with matugen, the hyprgreetr colors in the config will be changed,
# so put not to much effort into colors. In ~/.config/hyprgreetr/pngs are some example Images to show in hyprgreetr, but
# you can also use your own. 


micro ~/.config/fish/config.fish
	## past content at end of file ##
	function fish_greeting
		hyprgreetr
	end

Ctrl+S
Ctrl+Q

micro /usr/share/cachyos-fish-config/cachyos-config.fish
# add #<- before line 7-9 (we comment out because the greeter is set in your local users fish config in the step before)
Ctrl+S
Ctrl+Q

### Theme settings in terminal ###
gsettings set org.gnome.desktop.interface icon-theme 'kora-pgrey'
gsettings set org.gnome.desktop.interface cursor-theme 'Bibata-Modern-Ice'
gsettings set org.gnome.desktop.interface cursor-size 28

### configure SDDM Theme ###
sudo micro /etc/sddm.conf
	## past content ##
[General]
InputMethod=qtvirtualkeyboard
GreeterEnvironment=QML2_IMPORT_PATH=/usr/share/sddm/themes/silent/components/,QT_IM_MODULE=qtvirtualkeyboard

[Theme]
Current=silent

##end

### Set the Celona configuration ###
#Copy the .config Folder from the Celona Repo into your local .config Folder und override existing files there.
rsync -a ~/.config/quickshell/Celona/.config/ ~/.config/
sudo rsync -a ~/.config/quickshell/Celona/.sddm_conf/metadata.desktop /usr/share/sddm/themes/silent/metadata.desktop
sudo rsync -a ~/.config/quickshell/Celona/.sddm_conf/celona.conf /usr/share/sddm/themes/silent/configs/
sudo rsync -a ~/.config/quickshell/Celona/wallpapers/3440x1440/ /usr/share/sddm/themes/silent/backgrounds/


reboot
#log into the system, klick the gear icon on the lift side of the bar. Make your changes. Don't forget to set your Wallpaper.
#for the frist days its a good choice to enable the Keybindis Module, so you can access the important Keybindings from
#the Bar.

#final setep:
micro ~/.config/niri/config.kdl

# on line 16 set your prefered keyboard layout again "us" "de" ...
# on line 82 set your resolution and refresh rate. In my case mode "3440x1440@165.030" but yours is maybe "1920x1080@60.030"
# on line 128 set your max horizontal resulutions minus some pixels. I chosse -20 pixel




##CachyOS Settings
#Open the Hello App
Ctrl+SUPER+Return
#Type "Hello" then RETURN
#open Apps/Tweaks
#Click on "Rank Mirrors"
#Optional if you want to game: click on Install Gaming packages
#Optional if you choose btrfs Filesystem and Limine or Grub bootloader:
Ctrl+SUPER+Return
#Type "Btrfs" then RETURN
#Check if the snapshots are activated, with this option you can return to oder system states right from the bootmanager, damn cool!


todo: 
create config for home for snapper
create post snapshot for installed Celona
